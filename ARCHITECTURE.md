# Архитектура микросервиса обработки фотографий

## Обзор

Микросервис для обработки фотографий с лицами: детектирует лицо, центрирует и обрезает до квадрата 512x512 с нормализованным масштабом лица.

## Архитектурные решения

### Выбор технологий

1. **MediaPipe Face Detection** (вместо InsightFace)
   - ✅ Быстрая инициализация (не требует загрузки больших моделей)
   - ✅ CPU-оптимизированный
   - ✅ Хорошее качество детекции на разных масштабах
   - ✅ Встроенная поддержка landmarks через Face Mesh

2. **FastAPI**
   - ✅ Асинхронная обработка
   - ✅ Автоматическая документация API
   - ✅ Простая интеграция с multipart/form-data

3. **OpenCV + PIL**
   - ✅ Эффективная обработка изображений
   - ✅ Поддержка EXIF ориентации
   - ✅ Качественное масштабирование и кроп

### Архитектура обработки

```
┌─────────────────┐
│  HTTP Request   │
│  (до 5 файлов)  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   FastAPI       │
│   Endpoint      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ FaceProcessor   │
│                 │
│ 1. Детекция     │◄─── MediaPipe Face Detection
│ 2. Landmarks    │◄─── MediaPipe Face Mesh
│ 3. Выравнивание │
│ 4. Масштабир.   │
│ 5. Кроп 512x512 │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  ZIP Archive    │
│  (результаты)   │
└─────────────────┘
```

### Pipeline обработки изображения

1. **Загрузка и декодирование**
   - Чтение байтов изображения
   - Декодирование через OpenCV
   - Исправление EXIF ориентации

2. **Детекция лица**
   - MediaPipe Face Detection (model_selection=1 для дальних лиц)
   - Выбор лучшего лица если несколько (по размеру + confidence + позиции)

3. **Получение landmarks**
   - MediaPipe Face Mesh (468 точек)
   - Fallback на bbox если landmarks недоступны

4. **Выравнивание**
   - Вычисление угла по глазам
   - Поворот изображения для горизонтальности
   - Пересчет координат после поворота

5. **Нормализация масштаба**
   - Вычисление размера лица
   - Масштабирование до целевого размера (65% высоты 512px)
   - Пересчет координат центра

6. **Кроп и padding**
   - Кроп квадрата 512x512 вокруг центра лица
   - Reflect padding если выходит за границы
   - Финальная проверка размера

### Обработка edge cases

1. **Несколько лиц**: Выбор по комбинации размера, confidence и позиции
2. **Маленькое лицо**: Увеличение масштаба (до 3x), иначе ошибка
3. **Частичное лицо**: Использование bbox как fallback
4. **Выход за границы**: Reflect padding для естественного вида
5. **Поворот**: Автоматическое выравнивание по глазам
6. **EXIF**: Автоматическое исправление ориентации

### Производительность

- **CPU-only**: Полностью работает на CPU
- **Быстрая инициализация**: MediaPipe не требует загрузки больших моделей
- **Обработка**: ~0.5-2 секунды на изображение (зависит от размера и CPU)

### Масштабирование

1. **Горизонтальное**: Запуск нескольких инстансов за load balancer
2. **Вертикальное**: Увеличение CPU/RAM для обработки больших изображений
3. **Асинхронность**: FastAPI позволяет обрабатывать несколько запросов параллельно

### Безопасность

- Валидация типов файлов (только изображения)
- Лимит на количество файлов (до 5)
- Обработка ошибок без утечки информации
- Временные файлы очищаются автоматически

### Мониторинг

Рекомендуется добавить:
- Метрики latency (p50, p95, p99)
- Метрики успешности обработки
- Логирование ошибок
- Трейсинг запросов
